#!/usr/bin/env python3
"""
Generate Signed URLs for Patreon Daily Posts (or Monthly Bundles).

This script generates time-limited signed URLs for the Tier 1, 2, and 3 dataset files.
Key Features:
- Uses R2 credentials from environment (via r2_config).
- Generates links expiring in 7 days (default).
- Supports both Daily (--date) and Monthly (--month) modes.
"""

import boto3
import argparse
import sys
from datetime import datetime, timedelta, timezone
from r2_config import get_r2_config

# Default Expiry: 7 days (604800 seconds)
DEFAULT_EXPIRY_DAYS = 7


def generate_presigned_url(s3_client, bucket, key, expiration=3600, download_name=None):
    """Generate a presigned URL to share an S3 object."""
    params = {'Bucket': bucket, 'Key': key}
    if download_name:
        params['ResponseContentDisposition'] = f'attachment; filename="{download_name}"'

    try:
        response = s3_client.generate_presigned_url(
            'get_object',
            Params=params,
            ExpiresIn=expiration
        )
    except Exception as e:
        print(f"Error signing {key}: {e}", file=sys.stderr)
        return None
    return response


def main():
    parser = argparse.ArgumentParser(description="Generate Patreon download links.")
    parser.add_argument("--date", help="Target date (YYYY-MM-DD).")
    parser.add_argument("--month", help="Target month (YYYY-MM).")
    parser.add_argument("--days", type=int, default=DEFAULT_EXPIRY_DAYS, help="Expiry in days.")
    args = parser.parse_args()

    # Determine Mode
    if args.month:
        mode = "monthly"
        target_str = args.month
    elif args.date:
        mode = "daily"
        target_str = args.date
    else:
        # Default to yesterday (daily mode)
        mode = "daily"
        yesterday = datetime.now(timezone.utc) - timedelta(days=1)
        target_str = yesterday.strftime("%Y-%m-%d")

    # Load Config
    try:
        cfg = get_r2_config()
    except Exception as e:
        print(f"Error loading credentials: {e}", file=sys.stderr)
        sys.exit(1)

    # Initialize Client
    s3 = boto3.client(
        's3',
        endpoint_url=cfg.endpoint,
        aws_access_key_id=cfg.access_key_id,
        aws_secret_access_key=cfg.secret_access_key,
        region_name='auto'
    )

    expiry_seconds = args.days * 24 * 60 * 60

    print(f"--- PATREON LINKS FOR {target_str} ({mode.upper()}) ---")
    print(f"(Links expire in {args.days} days)\n")

    tiers = [
        ("Tier 1 (Explorer)", "tier1"),
        ("Tier 2 (Analyst)", "tier2"),
        ("Tier 3 (Researcher)", "tier3")
    ]

    for label, folder in tiers:
        if mode == "daily":
            month_str = target_str[:7]
            key = f"{folder}/daily/{month_str}/{target_str}/instrumetriq_{folder}_daily_{target_str}.parquet"
        else:
            key = f"{folder}/monthly/{target_str}/instrumetriq_{folder}_monthly_{target_str}.parquet"
        
        # Check if file exists
        try:
            s3.head_object(Bucket=cfg.bucket, Key=key)
            # File exists, generate link
            url = generate_presigned_url(s3, cfg.bucket, key, expiry_seconds)
            print(f"üîπ {label}")
            print(f"{url}\n")
        except:
            if mode == "monthly":
                 print(f"‚ö†Ô∏è {label}: Bundle not found ({key})")
                 print(f"   (Hint: Run 'python3 scripts/build_monthly_bundle.py --tier {folder} --month {target_str} --upload' first)\n")
            else:
                 print(f"‚ö†Ô∏è {label}: File not found in R2 ({key})\n")

    print("-" * 40)


if __name__ == "__main__":
    main()
