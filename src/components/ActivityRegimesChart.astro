---
/**
 * Activity Regimes Chart (Phase 4A)
 * Visualizes activity bins distribution from activity_regimes.json
 * Chart shows session counts per activity bin as horizontal bars
 */
import type { ActivityRegimesData } from '../lib/artifactsData';

interface Props {
  data: ActivityRegimesData;
}

const { data } = Astro.props;
const chartId = `activityRegimesChart-${Math.random().toString(36).substr(2, 9)}`;
const chartData = JSON.stringify(data);
---

<div class="chart-wrapper">
  <div class="chart-container">
    <canvas id={chartId} data-chart-data={chartData}></canvas>
  </div>
</div>

<script>
  import Chart from 'chart.js/auto';
  
  // Initialize all charts when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    const canvases = document.querySelectorAll('canvas[id^="activityRegimesChart-"]');
    
    canvases.forEach((canvas) => {
      const chartDataStr = canvas.getAttribute('data-chart-data');
      if (!chartDataStr) return;
      
      try {
        const data = JSON.parse(chartDataStr);
        
        // Extract labels and values from regimes
        const labels = data.regimes.map(r => r.bin.replace('_', ' '));
        const values = data.regimes.map(r => r.n_entries);
        
        // Configure Chart.js with dark theme
        new Chart(canvas, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Entries',
              data: values,
              backgroundColor: 'rgba(0, 188, 212, 0.6)',
              borderColor: '#00bcd4',
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: '#222222',
                titleColor: '#f0f0f0',
                bodyColor: '#b0b0b0',
                borderColor: '#2d2d2d',
                borderWidth: 1,
                padding: 12,
                displayColors: false
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  color: '#b0b0b0'
                },
                grid: {
                  color: '#2d2d2d'
                }
              },
              y: {
                ticks: {
                  color: '#b0b0b0'
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } catch (e) {
        console.error('Failed to initialize activity regimes chart:', e);
      }
    });
  });
</script>

<style>
  .chart-wrapper {
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .chart-heading {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .chart-container {
    background: var(--panel);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    border: 1px solid var(--border);
  }

  canvas {
    max-width: 100%;
    height: auto;
  }
</style>
