---
import BaseLayout from '../layouts/BaseLayout.astro';
import PageHero from '../components/PageHero.astro';
import { 
  loadArtifacts, 
  loadDatasetOverview,
  formatPercent, 
  formatNumber, 
  formatDuration,
  formatReturnPercent
} from '../lib/artifactsData';
import fs from 'node:fs';
import path from 'node:path';

// Load Phase 3A artifact (surface-level overview)
const datasetOverview = loadDatasetOverview();

// Load archive statistics (full archive scale)
const archiveStatsPath = path.join(process.cwd(), 'public/data/archive_stats.json');
let archiveStats = null;
try {
  if (fs.existsSync(archiveStatsPath)) {
    archiveStats = JSON.parse(fs.readFileSync(archiveStatsPath, 'utf-8'));
  }
} catch (error) {
  console.error('Error loading archive stats:', error);
}

// Load semantic artifacts (coverage table and dataset summary)
const coverageTablePath = path.join(process.cwd(), 'public/data/coverage_table.json');
const datasetSummaryPath = path.join(process.cwd(), 'public/data/dataset_summary.json');
const symbolTablePath = path.join(process.cwd(), 'public/data/symbol_table.json');

let coverageTable = null;
let datasetSummary = null;
let symbolTable = null;

try {
  if (fs.existsSync(coverageTablePath)) {
    coverageTable = JSON.parse(fs.readFileSync(coverageTablePath, 'utf-8'));
  }
  if (fs.existsSync(datasetSummaryPath)) {
    datasetSummary = JSON.parse(fs.readFileSync(datasetSummaryPath, 'utf-8'));
  }
  if (fs.existsSync(symbolTablePath)) {
    symbolTable = JSON.parse(fs.readFileSync(symbolTablePath, 'utf-8'));
  }
} catch (error) {
  console.error('Error loading semantic artifacts:', error);
}

const artifacts = loadArtifacts();
---

<BaseLayout 
  title="Dataset - Instrumetriq"
  description="Dataset details: validated market snapshots with coverage, scale, behavior patterns, and transparency metrics."
>
  <PageHero
    eyebrow="DATASET"
    title="Dataset"
    subtitle="Validated market snapshots: v7 schema with coverage details, scale metrics, and behavioral summaries."
  />
  
  <!-- Readiness banner (Phase 3A with archive scale) -->
  {archiveStats && (
    <div class="readiness-banner pass">
      <div class="banner-main">
        <strong>Full Archive:</strong> {formatNumber(archiveStats.total_entries_all_time)} validated entries
        <span class="badge">READY</span>
      </div>
      <div class="banner-details">
        {archiveStats.total_days} days archived
        â€¢ {archiveStats.first_day_utc} to {archiveStats.last_day_utc}
      </div>
      <div class="banner-link">
        Public preview: 100-entry rotating sample updated daily
      </div>
    </div>
  )}
  
  <div class="pageContent">
    <!-- Section 1: Scale & Freshness -->
    {archiveStats && (
      <section>
        <h2>Archive Scale & Freshness</h2>
        <div class="overview-grid">
          <div class="overview-card">
            <div class="card-label">Total Entries</div>
            <div class="card-value">{formatNumber(archiveStats.total_entries_all_time)}</div>
          </div>
          <div class="overview-card">
            <div class="card-label">Days Archived</div>
            <div class="card-value">{archiveStats.total_days}</div>
          </div>
          <div class="overview-card">
            <div class="card-label">Date Range (UTC)</div>
            <div class="card-value">{archiveStats.first_day_utc}<br/>to {archiveStats.last_day_utc}</div>
          </div>
          {archiveStats.last_entry_ts_utc && (
            <div class="overview-card">
              <div class="card-label">Last Entry</div>
              <div class="card-value">{archiveStats.last_entry_ts_utc.substring(0, 19).replace('T', ' ')}</div>
            </div>
          )}
        </div>
        <p class="freshness-note">
          <strong>Preview sample:</strong> 100-entry rotating snapshot from latest archive (updated daily)
        </p>
      </section>
    )}
    
    <!-- Section 2: Coverage (What We Collect) -->
    {coverageTable && coverageTable.feature_groups && (
      <section>
        <h2>What We Collect</h2>
        <p>
          Each entry is a market snapshot. Feature groups show which data blocks are present across snapshots. 
          A group's "present rate" indicates the percentage of validated entries that include that feature block.
        </p>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Feature Group</th>
                <th>Present Rate</th>
                <th>Notes</th>
                <th>Example Metric</th>
              </tr>
            </thead>
            <tbody>
              {coverageTable.feature_groups.map((group: any) => {
                const rate = group.present_rate_pct / 100;
                let exampleText = 'â€”';
                
                if (typeof group.example_metric_value === 'number') {
                  // Numeric value - format with label
                  const formattedValue = Number.isInteger(group.example_metric_value) 
                    ? formatNumber(group.example_metric_value)
                    : group.example_metric_value.toFixed(2);
                  exampleText = `${group.example_metric_label}: ${formattedValue}`;
                } else if (typeof group.example_metric_value === 'string') {
                  // String explanation for 0% groups
                  exampleText = group.example_metric_value;
                }
                
                return (
                  <tr>
                    <td><code>{group.group}</code></td>
                    <td>{formatPercent(rate)}</td>
                    <td class={rate === 0 ? 'text-muted' : ''}>{group.example_metric_note || 'â€”'}</td>
                    <td class={rate === 0 ? 'text-muted' : ''}>{exampleText}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </section>
    )}
    
    <!-- Section 4: Non-Claims -->
    {datasetOverview && datasetOverview.non_claims_block && (
      <section>
        <h2>Dataset Disclaimers</h2>
        <div class="non-claims-box">
          <ul>
            {datasetOverview.non_claims_block.map((item) => (
              <li>{item}</li>
            ))}
          </ul>
        </div>
      </section>
    )}
    
    <!-- Section 5: Public Sample Entries (Phase 3B-hotfix: client-side fetch) -->
    <section id="dataset-sample">
      <h2>Dataset Sample</h2>
      <div class="sample-preview-intro">
        <p>
          Browse recent archived entries and inspect the full field structure.
        </p>
      </div>
      <div class="preview-info-bar">
        <a href="/data/sample_entries_v7.jsonl" download class="download-link">
          ðŸ“¥ Download JSONL
          <span class="download-note">ideal for quick integration tests</span>
        </a>
        <p class="preview-timestamp" id="previewTimestamp">Loading...</p>
      </div>
      
      <!-- Placeholder container for client-side rendering -->
      <div 
        id="public-dataset-preview" 
        data-json="/data/sample_entries_v7.json" 
        data-spots="/data/sample_entries_spots_v7.json"
      >
        <p class="loading-message">Loading dataset preview...</p>
      </div>
    </section>
    
    <!-- Legacy sections below - available when semantic artifacts are built -->
    <!-- Section OLD-2: Scale -->
    {datasetSummary && datasetSummary.scale && (
      <section>
        <h2>Scale (Legacy)</h2>
        <div class="scale-grid">
          <div class="scale-card">
            <div class="scale-label">Days Running</div>
            <div class="scale-value">{datasetSummary.scale.days_running}</div>
          </div>
          <div class="scale-card">
            <div class="scale-label">Total Usable</div>
            <div class="scale-value">{formatNumber(datasetSummary.scale.total_usable_entries)}</div>
          </div>
          <div class="scale-card">
            <div class="scale-label">Avg Per Day</div>
            <div class="scale-value">{formatNumber(datasetSummary.scale.avg_entries_per_day)}</div>
          </div>
          <div class="scale-card">
            <div class="scale-label">Distinct Symbols</div>
            <div class="scale-value">{formatNumber(datasetSummary.scale.distinct_symbols)}</div>
          </div>
        </div>
        {datasetSummary.posts_scored && (
          <p class="posts-scored-line">
            Posts scored: {formatNumber(datasetSummary.posts_scored.total_posts)} 
            (from {formatNumber(datasetSummary.posts_scored.from_entries)} entries)
          </p>
        )}
      </section>
    )}
    
    <!-- Section 4: Sentiment Buckets -->
    {datasetSummary && datasetSummary.sentiment_buckets && (
      <section>
        <h2>Sentiment Distribution</h2>
        {datasetSummary.sentiment_buckets.reason_unavailable ? (
          <div class="unavailable-notice">
            <p><strong>Unavailable:</strong> {datasetSummary.sentiment_buckets.reason_unavailable}</p>
            <p class="text-muted">This section will show the distribution of sentiment scores across entries when the data becomes available. This is purely descriptive and makes no claims about predictive value or market correlation.</p>
          </div>
        ) : datasetSummary.sentiment_buckets.buckets && datasetSummary.sentiment_buckets.buckets.length > 0 ? (
          <>
            <p>
              Distribution of entries across sentiment score ranges. 
              <strong>This is descriptive only</strong> â€” it shows what was observed, not what might predict future outcomes. 
              No correlation with returns or trading edge is implied or claimed.
            </p>
            <p class="disclaimer-emphasis">{datasetSummary.sentiment_buckets.disclaimer}</p>
            <div class="table-wrapper">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Sentiment Range</th>
                    <th>Entry Count</th>
                  </tr>
                </thead>
                <tbody>
                  {datasetSummary.sentiment_buckets.buckets.map((bucket: any) => (
                    <tr>
                      <td><code>{bucket.label}</code></td>
                      <td>{formatNumber(bucket.n_entries)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </>
        ) : (
          <p class="text-muted">No sentiment bucket data available.</p>
        )}
      </section>
    )}
    
    {datasetSummary && datasetSummary.activity_regimes && datasetSummary.activity_regimes.bins && (
      <section>
        <h2>Activity Regimes by Post Volume</h2>
        <p>
          <strong>Activity regime</strong> is based on posts_total observed in the sentiment window for a session. 
          Entries are grouped by post volume to show market characteristics across different activity levels.
        </p>
        <p class="definition-note">{datasetSummary.activity_regimes.definition}</p>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Posts Range</th>
                <th>Entries</th>
                <th>Median Spread (bps)</th>
                <th>P90 Spread (bps)</th>
              </tr>
            </thead>
            <tbody>
              {datasetSummary.activity_regimes.bins.map((bin: any) => (
                <tr>
                  <td><code>{bin.label}</code></td>
                  <td>{formatNumber(bin.n_entries)}</td>
                  <td>{bin.metrics.median_spread_bps ? bin.metrics.median_spread_bps.toFixed(2) : 'â€”'}</td>
                  <td>{bin.metrics.p90_spread_bps ? bin.metrics.p90_spread_bps.toFixed(2) : 'â€”'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>
    )}
    

    
    {artifacts.confidence && (
      <section>
        <h2>Confidence vs Disagreement</h2>
        <p>
          Disagreement rate binned by referee confidence. Shows when referee overrides primary decision.
        </p>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Confidence Bin</th>
                <th>N</th>
                <th>Disagreement Rate</th>
              </tr>
            </thead>
            <tbody>
              {artifacts.confidence.bins
                .filter(bin => bin.sample_count > 0)
                .map(bin => (
                  <tr>
                    <td><code>{bin.bin_label}</code></td>
                    <td>{formatNumber(bin.sample_count)}</td>
                    <td>{formatPercent(bin.disagreement_rate)}</td>
                  </tr>
                ))}
            </tbody>
          </table>
        </div>
      </section>
    )}
    
    <!-- Section 6: Symbol Table -->
    {symbolTable && symbolTable.symbols && (
      <section>
        <h2>Symbol Table</h2>
        <p class="session-definition">
          A session is one monitoring window (about 2 hours) for a symbol in the active watchlist.
        </p>
        <div class="symbol-table-controls">
          <input 
            type="text" 
            id="symbolSearch" 
            placeholder="Search symbols..."
            class="symbol-search-input"
          />
          <div class="symbol-count-display" id="symbolCount">
            Showing <span id="visibleCount">50</span> of <span id="totalCount">{symbolTable.total_symbols}</span> symbols
          </div>
        </div>
        <div class="table-wrapper">
          <table class="data-table symbol-table" id="symbolTableElement">
            <thead>
              <tr>
                <th data-sort="symbol" class="sortable">Symbol <span class="sort-indicator"></span></th>
                <th data-sort="sessions" class="sortable">Sessions <span class="sort-indicator"></span></th>
                <th data-sort="median_posts" class="sortable">Median Posts <span class="sort-indicator"></span></th>
                <th data-sort="p90_posts" class="sortable">P90 Posts <span class="sort-indicator"></span></th>
                <th data-sort="silence_rate" class="sortable">Silence Rate % <span class="sort-indicator"></span></th>
                <th data-sort="median_spread" class="sortable">Median Spread (bps) <span class="sort-indicator"></span></th>
              </tr>
            </thead>
            <tbody id="symbolTableBody">
              {/* Rows populated by client-side script */}
            </tbody>
          </table>
        </div>
        <button id="showAllButton" class="show-all-btn" style="display: none;">Show all results</button>
      </section>
    )}
    
    <!-- Honesty Block -->
    <section>
      <h2>What We Do Not Claim</h2>
      <div class="honesty-block">
        <ul>
          <li><strong>No live signals:</strong> This dataset is for research and analysis, not real-time trading</li>
          <li><strong>No guaranteed correlation:</strong> Patterns shown are descriptive, not predictive</li>
          <li><strong>No post-hoc filtering:</strong> Data passes automated gates only, no cherry-picking</li>
          <li><strong>No execution advice:</strong> This is not financial advice or investment guidance</li>
        </ul>
      </div>
    </section>
    
    <!-- Original context sections -->
    <section>
      <h2>About the Dataset</h2>
      <p>
        A record is a single validated <strong>v7 snapshot</strong>â€”frozen at admission and required to pass dataset health gates (700+ spot samples minimum). Each snapshot captures a moment in time, combining market microstructure, high-resolution price samples, and aggregated social sentiment windows.
      </p>
      <p>
        See <a href="/access">Access</a> for subscription tiers and pricing.
      </p>
    </section>
    
    <section>
      <h2>Dataset Structure</h2>
      <p>
        Detailed schema documentation, file formats, and field definitions will be provided with the first public release. Future documentation will include versioned schemas, migration guides, and format specifications.
      </p>
    </section>
    
    <section>
      <h2>Access & Licensing</h2>
      <p>
        Public releases will include comprehensive documentation and a Python quickstart for reading and exploring the data. Access terms and licensing details will be finalized and published alongside the first release.
      </p>
    </section>
  </div>
</BaseLayout>

<style>
  .loading-message {
    padding: var(--space-4);
    text-align: center;
    color: var(--text-muted);
  }
  
  .error-message {
    padding: var(--space-4);
    text-align: center;
    color: #ef4444;
  }
</style>

<script is:inline>
  // Phase 3B-hotfix: Client-side fetch to avoid 25 MiB HTML limit
  document.addEventListener('DOMContentLoaded', async () => {
    const container = document.getElementById('public-dataset-preview');
    const timestampElem = document.getElementById('previewTimestamp');
    
    if (!container) return;
    
    const jsonUrl = container.getAttribute('data-json');
    const spotsUrl = container.getAttribute('data-spots');
    
    if (!jsonUrl) {
      container.innerHTML = '<p class="error-message">Configuration error: missing data URL</p>';
      return;
    }
    
    let spotsData = null;
    
    try {
      const response = await fetch(jsonUrl);
      if (!response.ok) {
        throw new Error(`Failed to load dataset preview: ${response.status}`);
      }
      
      const data = await response.json();
      const entries = data.entries || [];
      
      if (timestampElem && data.generated_at_utc) {
        timestampElem.textContent = `Preview updated: ${data.generated_at_utc}`;
      }
      
      function parseNumericValue(text) {
        if (!text || text === 'N/A') return null;
        const num = parseFloat(text);
        return isNaN(num) ? null : num;
      }
      
      const tableHTML = `
        <div class="sample-table-wrapper">
          <div class="table-controls">
            <input type="text" id="sampleSymbolSearch" placeholder="Search by symbol..." class="search-input" />
          </div>
          <table class="sample-table" id="sampleTable">
            <thead>
              <tr>
                <th data-sort="symbol">Symbol</th>
                <th data-sort="spread_bps" class="numeric">Spread (bps)</th>
                <th data-sort="liq_global_pct" class="numeric">Liq Global %</th>
                <th data-sort="posts_total" class="numeric">Posts (L2C)</th>
                <th data-sort="mean_score" class="numeric">Mean Score</th>
                <th data-sort="added_ts">Added (UTC)</th>
                <th class="expand-col">Details</th>
              </tr>
            </thead>
            <tbody>
              ${entries.map((entry, idx) => {
                const spreadBps = entry.derived?.spread_bps?.toFixed(2) ?? 'N/A';
                const liqGlobalPct = entry.derived?.liq_global_pct?.toFixed(2) ?? 'N/A';
                const postsTotal = entry.twitter_sentiment_windows?.last_2_cycles?.posts_total ?? 'N/A';
                const meanScore = entry.twitter_sentiment_windows?.last_2_cycles?.hybrid_decision_stats?.mean_score?.toFixed(4) ?? 'N/A';
                const addedTs = entry.meta?.added_ts ? entry.meta.added_ts.substring(0, 19).replace('T', ' ') : 'N/A';
                
                return `
                  <tr class="sample-row" data-idx="${idx}">
                    <td class="symbol-cell">${entry.symbol}</td>
                    <td class="numeric">${spreadBps}</td>
                    <td class="numeric">${liqGlobalPct}</td>
                    <td class="numeric">${postsTotal}</td>
                    <td class="numeric">${meanScore}</td>
                    <td>${addedTs}</td>
                    <td class="expand-cell">
                      <button class="expand-btn fields-btn" data-target="fields">Fields</button>
                      <button class="expand-btn spots-btn" data-target="spots">Spots</button>
                    </td>
                  </tr>
                  <tr class="json-row fields-row" id="fields-${idx}" style="display: none;">
                    <td colspan="7">
                      <div class="json-header">Entry Fields</div>
                      <pre class="json-content"><code>${JSON.stringify(entry, null, 2)}</code></pre>
                    </td>
                  </tr>
                  <tr class="json-row spots-row" id="spots-${idx}" style="display: none;">
                    <td colspan="7">
                      <div class="json-header">Spot Prices</div>
                      <div class="spot-content" data-symbol="${entry.symbol}">Loading...</div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = tableHTML;
      
      async function loadSpotsData() {
        if (spotsData) return spotsData;
        if (!spotsUrl) throw new Error('Spots data URL not configured');
        
        const response = await fetch(spotsUrl);
        if (!response.ok) throw new Error(`Failed to load spots data: ${response.status}`);
        
        const data = await response.json();
        spotsData = {};
        (data.spots || []).forEach(item => {
          spotsData[item.symbol] = item.spot_prices || [];
        });
        return spotsData;
      }
      
      const expandButtons = document.querySelectorAll('.expand-btn');
      expandButtons.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const row = btn.closest('tr');
          if (!row) return;
          
          const idx = row.getAttribute('data-idx');
          if (!idx) return;
          
          const target = btn.getAttribute('data-target');
          const targetRow = document.getElementById(`${target}-${idx}`);
          if (!targetRow) return;
          
          if (target === 'spots' && targetRow.style.display === 'none') {
            const spotContent = targetRow.querySelector('.spot-content');
            if (spotContent && spotContent.textContent === 'Loading...') {
              try {
                const spots = await loadSpotsData();
                const symbol = spotContent.getAttribute('data-symbol');
                const spotPrices = spots[symbol] || [];
                
                if (spotPrices.length > 0) {
                  spotContent.innerHTML = `<div class="json-header">Spot prices â€” ${spotPrices.length} samples</div><pre class="json-content"><code>${JSON.stringify(spotPrices, null, 2)}</code></pre>`;
                } else {
                  spotContent.innerHTML = '<div class="no-data">No spot price data available for this entry.</div>';
                }
              } catch (err) {
                spotContent.innerHTML = `<div class="error-message">Failed to load spot prices: ${err.message}</div>`;
              }
            }
          }
          
          if (targetRow.style.display === 'none' || !targetRow.style.display) {
            targetRow.style.display = 'table-row';
            btn.classList.add('active');
          } else {
            targetRow.style.display = 'none';
            btn.classList.remove('active');
          }
        });
      });
      
      // Scope search input to Dataset Sample section
      const datasetSampleRoot = document.getElementById('dataset-sample');
      const searchInput = datasetSampleRoot?.querySelector('#sampleSymbolSearch');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          const rows = document.querySelectorAll('.sample-row');
          
          rows.forEach(row => {
            const symbol = row.querySelector('.symbol-cell');
            const idx = row.getAttribute('data-idx');
            
            if (symbol && symbol.textContent.toLowerCase().includes(query)) {
              row.style.display = 'table-row';
            } else {
              row.style.display = 'none';
              const fieldsRow = idx ? document.getElementById(`fields-${idx}`) : null;
              const spotsRow = idx ? document.getElementById(`spots-${idx}`) : null;
              if (fieldsRow) fieldsRow.style.display = 'none';
              if (spotsRow) spotsRow.style.display = 'none';
            }
          });
        });
      }
      
      const headers = document.querySelectorAll('.sample-table thead th[data-sort]');
      let sortState = { column: null, ascending: true };
      
      headers.forEach(header => {
        header.addEventListener('click', () => {
          const column = header.getAttribute('data-sort');
          if (!column) return;
          
          const table = document.getElementById('sampleTable');
          if (!table) return;
          
          const tbody = table.querySelector('tbody');
          if (!tbody) return;
          
          const rows = Array.from(tbody.querySelectorAll('.sample-row'));
          
          if (sortState.column === column) {
            sortState.ascending = !sortState.ascending;
          } else {
            sortState.column = column;
            sortState.ascending = true;
          }
          
          rows.sort((a, b) => {
            switch (column) {
              case 'symbol':
                const aSymbol = a.querySelector('.symbol-cell');
                const bSymbol = b.querySelector('.symbol-cell');
                if (!aSymbol?.textContent || !bSymbol?.textContent) return 0;
                return sortState.ascending ? aSymbol.textContent.localeCompare(bSymbol.textContent) : bSymbol.textContent.localeCompare(aSymbol.textContent);
              
              case 'spread_bps':
              case 'liq_global_pct':
              case 'posts_total':
              case 'mean_score':
                const colIdx = Array.from(header.parentElement.children).indexOf(header);
                const aNum = parseNumericValue(a.children[colIdx]?.textContent || '');
                const bNum = parseNumericValue(b.children[colIdx]?.textContent || '');
                
                // N/A values always go to bottom regardless of sort direction
                if (aNum === null && bNum === null) return 0;
                if (aNum === null) return 1;  // a is N/A, goes to bottom
                if (bNum === null) return -1; // b is N/A, goes to bottom
                
                return sortState.ascending ? aNum - bNum : bNum - aNum;
              
              case 'added_ts':
                const tsIdx = Array.from(header.parentElement.children).indexOf(header);
                const aTsVal = a.children[tsIdx]?.textContent || '';
                const bTsVal = b.children[tsIdx]?.textContent || '';
                return sortState.ascending ? aTsVal.localeCompare(bTsVal) : bTsVal.localeCompare(aTsVal);
              
              default:
                return 0;
            }
          });
          
          rows.forEach(row => {
            const idx = row.getAttribute('data-idx');
            tbody.appendChild(row);
            const fieldsRow = idx ? document.getElementById(`fields-${idx}`) : null;
            const spotsRow = idx ? document.getElementById(`spots-${idx}`) : null;
            if (fieldsRow) tbody.appendChild(fieldsRow);
            if (spotsRow) tbody.appendChild(spotsRow);
          });
          
          headers.forEach(h => {
            const text = h.textContent;
            if (text) h.textContent = text.replace(/[â–²â–¼]/g, '').trim();
          });
          const headerText = header.textContent;
          if (headerText) {
            header.textContent = headerText + (sortState.ascending ? ' â–²' : ' â–¼');
          }
        });
      });
      
    } catch (err) {
      console.error('Failed to load dataset preview:', err);
      container.innerHTML = `<p class="error-message">Preview unavailable. ${err.message}</p>`;
    }
  });
</script>

</BaseLayout>


<script is:inline define:vars={{ symbolTableData: symbolTable }}>
  // Symbol table client-side functionality
  if (symbolTableData && symbolTableData.symbols) {
    const symbols = symbolTableData.symbols;
    const tbody = document.getElementById('symbolTableBody');
    const searchInput = document.getElementById('symbolSearch');
    const showAllButton = document.getElementById('showAllButton');
    const visibleCountSpan = document.getElementById('visibleCount');
    
    let filteredSymbols = [...symbols];
    let currentSort = { column: null, direction: 'asc' };
    let showAll = false;
    
    function formatValue(value) {
      if (value === null || value === undefined) return '\u2014';
      if (typeof value === 'number') {
        return Number.isInteger(value) ? value.toLocaleString() : value.toFixed(2);
      }
      return String(value);
    }
    
    function renderTable() {
      const displayLimit = showAll ? filteredSymbols.length : Math.min(50, filteredSymbols.length);
      const displaySymbols = filteredSymbols.slice(0, displayLimit);
      
      tbody.innerHTML = displaySymbols.map(sym => {
        return `
          <tr>
            <td><code>${sym.symbol}</code></td>
            <td>${formatValue(sym.sessions)}</td>
            <td>${formatValue(sym.activity?.median_posts_last_cycle)}</td>
            <td>${formatValue(sym.activity?.p90_posts_last_cycle)}</td>
            <td>${formatValue(sym.activity?.silence_rate_pct)}</td>
            <td>${formatValue(sym.market_context?.median_spread_bps)}</td>
          </tr>
        `;
      }).join('');
      
      visibleCountSpan.textContent = displayLimit;
      
      if (filteredSymbols.length > 50 && !showAll) {
        showAllButton.style.display = 'inline-block';
      } else {
        showAllButton.style.display = 'none';
      }
    }
    
    function sortSymbols(column) {
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      
      filteredSymbols.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
          case 'symbol':
            aVal = a.symbol;
            bVal = b.symbol;
            break;
          case 'sessions':
            aVal = a.sessions || 0;
            bVal = b.sessions || 0;
            break;
          case 'median_posts':
            aVal = a.activity?.median_posts_last_cycle || 0;
            bVal = b.activity?.median_posts_last_cycle || 0;
            break;
          case 'p90_posts':
            aVal = a.activity?.p90_posts_last_cycle || 0;
            bVal = b.activity?.p90_posts_last_cycle || 0;
            break;
          case 'silence_rate':
            aVal = a.activity?.silence_rate_pct || 0;
            bVal = b.activity?.silence_rate_pct || 0;
            break;
          case 'median_spread':
            aVal = a.market_context?.median_spread_bps || 0;
            bVal = b.market_context?.median_spread_bps || 0;
            break;
          default:
            return 0;
        }
        
        if (typeof aVal === 'string') {
          const cmp = aVal.localeCompare(bVal);
          return currentSort.direction === 'asc' ? cmp : -cmp;
        } else {
          return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
      });
      
      // Update sort indicators
      document.querySelectorAll('.symbol-table th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sort === column) {
          th.classList.add(`sort-${currentSort.direction}`);
        }
      });
      
      showAll = false;
      renderTable();
    }
    
    function filterSymbols() {
      const query = searchInput.value.toLowerCase().trim();
      
      if (!query) {
        filteredSymbols = [...symbols];
      } else {
        filteredSymbols = symbols.filter(sym => 
          sym.symbol.toLowerCase().includes(query)
        );
      }
      
      showAll = false;
      renderTable();
    }
    
    // Event listeners
    searchInput.addEventListener('input', filterSymbols);
    
    showAllButton.addEventListener('click', () => {
      showAll = true;
      renderTable();
    });
    
    document.querySelectorAll('.symbol-table th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        sortSymbols(th.dataset.sort);
      });
    });
    
    // Initial render (sort by sessions descending)
    sortSymbols('sessions');
  }
</script>

<style>
  .warning-banner {
    background-color: #fee;
    border-left: 4px solid #f44;
    padding: var(--space-3) var(--space-4);
    margin-bottom: var(--space-4);
    color: #600;
  }
  
  .readiness-banner {
    padding: var(--space-4);
    margin-bottom: var(--space-5);
    border-radius: 4px;
    border-left: 4px solid var(--accent);
  }
  
  .readiness-banner.pass {
    background-color: rgba(16, 185, 129, 0.1);
    border-color: #10b981;
  }
  
  .readiness-banner.fail {
    background-color: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
  }
  
  .banner-main {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 1.1rem;
    margin-bottom: var(--space-2);
  }
  
  .banner-main .badge {
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .readiness-banner.pass .badge {
    background-color: #10b981;
    color: white;
  }
  
  .readiness-banner.fail .badge {
    background-color: #ef4444;
    color: white;
  }
  
  .banner-details {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: var(--space-2);
  }
  
  .banner-details .error-hint {
    color: #ef4444;
    font-weight: 500;
  }
  
  .banner-link {
    font-size: 0.9rem;
  }
  
  .scale-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-3);
    margin-top: var(--space-4);
  }
  
  .scale-card {
    padding: var(--space-4);
    background-color: var(--panel2);
    border-radius: 4px;
    text-align: center;
  }
  
  .scale-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: var(--space-2);
  }
  
  .scale-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text);
  }
  
  .table-wrapper {
    overflow-x: auto;
    margin-top: var(--space-4);
  }
  
  .data-table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--panel2);
    font-size: 0.9rem;
  }
  
  .data-table th {
    background-color: var(--panel);
    padding: var(--space-3);
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--accent-dim);
  }
  
  .data-table td {
    padding: var(--space-3);
    border-bottom: 1px solid var(--panel);
  }
  
  .data-table tbody tr:hover {
    background-color: rgba(0, 188, 212, 0.05);
  }
  
  .data-table code {
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    color: var(--accent);
  }
  
  .preview-table-mono .mono-value {
    font-family: 'Lucida Sans Typewriter', 'Lucida Console', 'Consolas', 'Monaco', monospace;
    font-size: 0.85rem;
  }
  
  .posts-scored-line {
    margin-top: var(--space-4);
    padding: var(--space-3);
    background-color: var(--panel2);
    border-left: 3px solid var(--accent);
    font-size: 0.95rem;
  }
  
  .text-muted {
    color: var(--text-muted);
    font-style: italic;
  }
  
  .unavailable-notice {
    padding: var(--space-4);
    background-color: rgba(255, 193, 7, 0.1);
    border-left: 4px solid #ffc107;
    border-radius: 4px;
    margin-top: var(--space-3);
  }
  
  .unavailable-notice strong {
    color: #f59e0b;
  }
  
  .disclaimer-emphasis {
    font-style: italic;
    color: var(--text-muted);
    margin-bottom: var(--space-3);
  }
  
  .definition-note {
    font-size: 0.9rem;
    color: var(--text-muted);
    font-style: italic;
    margin-bottom: var(--space-3);
  }
  
  .session-definition {
    font-style: italic;
    color: var(--text-muted);
    margin-bottom: var(--space-4);
    padding: var(--space-2) var(--space-3);
    background-color: var(--panel2);
    border-left: 3px solid var(--accent-dim);
  }
  
  .symbol-table-controls {
    display: flex;
    gap: var(--space-3);
    align-items: center;
    margin-bottom: var(--space-3);
    flex-wrap: wrap;
  }
  
  .symbol-search-input {
    flex: 1;
    min-width: 200px;
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--accent-dim);
    border-radius: 4px;
    background-color: var(--panel2);
    color: var(--text);
    font-size: 0.9rem;
  }
  
  .symbol-search-input:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  .symbol-count-display {
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  
  .symbol-table {
    font-size: 0.85rem;
  }
  
  .symbol-table th.sortable {
    cursor: pointer;
    user-select: none;
  }
  
  .symbol-table th.sortable:hover {
    background-color: var(--accent-dim);
  }
  
  .symbol-table .sort-indicator {
    display: inline-block;
    width: 12px;
    margin-left: 4px;
  }
  
  .symbol-table th.sort-asc .sort-indicator::after {
    content: 'â–²';
    font-size: 0.7em;
  }
  
  .symbol-table th.sort-desc .sort-indicator::after {
    content: 'â–¼';
    font-size: 0.7em;
  }
  
  .show-all-btn {
    margin-top: var(--space-3);
    padding: var(--space-2) var(--space-4);
    background-color: var(--accent);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
  }
  
  .show-all-btn:hover {
    background-color: var(--accent-bright);
  }
  
  .note {
    margin-top: var(--space-3);
    font-size: 0.9rem;
    color: var(--text-muted);
    font-style: italic;
  }
  
  .honesty-block {
    padding: var(--space-4);
    background-color: var(--panel2);
    border-left: 4px solid #ef4444;
    border-radius: 4px;
    margin-top: var(--space-4);
  }
  
  .honesty-block ul {
    margin: 0;
    padding-left: var(--space-4);
  }
  
  .honesty-block li {
    margin-bottom: var(--space-2);
    color: var(--text-muted);
  }
  
  /* Phase 3A styles */
  .overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: var(--space-3);
    margin-top: var(--space-4);
  }
  
  .overview-card {
    padding: var(--space-4);
    background-color: var(--panel2);
    border-radius: 4px;
    text-align: center;
  }
  
  .card-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: var(--space-2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .card-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
    word-break: break-all;
  }
  
  .freshness-note {
    margin-top: var(--space-4);
    padding: var(--space-3);
    background-color: var(--panel2);
    border-radius: 4px;
    font-size: 0.9rem;
  }
  
  .non-claims-box {
    padding: var(--space-4);
    background-color: var(--panel2);
    border-left: 4px solid #f59e0b;
    border-radius: 4px;
    margin-top: var(--space-4);
  }
  
  .non-claims-box ul {
    margin: 0;
    padding-left: var(--space-4);
  }
  
  .non-claims-box li {
    margin-bottom: var(--space-3);
    color: var(--text-muted);
    line-height: 1.6;
  }

  /* Phase 3B: Featured Sample widget */
  .featured-sample-card {
    background-color: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: var(--space-4);
    margin-top: var(--space-4);
  }
  
  .featured-sample-content {
    margin-bottom: var(--space-4);
  }
  
  .featured-field {
    display: flex;
    justify-content: space-between;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--border);
  }
  
  .featured-field:last-child {
    border-bottom: none;
  }
  
  .featured-label {
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  
  .featured-value {
    font-family: 'Courier New', monospace;
    color: var(--text);
    font-size: 0.95rem;
  }
  
  .featured-value.symbol {
    color: var(--accent);
    font-weight: 600;
    font-size: 1.1rem;
  }
  
  .featured-sample-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: var(--space-3);
    border-top: 1px solid var(--border);
  }
  
  .nav-btn {
    padding: var(--space-2) var(--space-3);
    background-color: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  
  .nav-btn:hover {
    background-color: var(--panel3);
    border-color: var(--accent);
  }
  
  .nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .counter {
    font-size: 0.9rem;
    color: var(--text-muted);
  }
</style>

<!-- Global styles for Dataset Sample (client-side injected HTML) -->
<style is:global>
  /* Phase 3B: Dataset sample section - global styles for dynamic content */
  #dataset-sample .sample-preview-intro {
    margin-bottom: var(--space-3);
  }
  
  #dataset-sample .sample-preview-intro p {
    font-size: 1rem;
    line-height: 1.6;
    color: var(--text);
  }
  
  #dataset-sample .preview-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-3) var(--space-4);
    margin-bottom: var(--space-4);
    background: linear-gradient(to right, var(--panel2), var(--panel));
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  
  #dataset-sample .download-link {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s;
  }
  
  #dataset-sample .download-link:hover {
    color: var(--text);
    transform: translateX(2px);
  }
  
  #dataset-sample .download-note {
    font-size: 0.8rem;
    color: var(--text-muted);
    font-weight: 400;
  }
  
  #dataset-sample .preview-timestamp {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: 0;
  }
  
  @media (max-width: 768px) {
    #dataset-sample .preview-info-bar {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2);
    }
  }
  
  #dataset-sample .sample-table-wrapper {
    margin-top: 0;
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid var(--border);
    background-color: var(--panel);
  }
  
  #dataset-sample .table-controls {
    margin-bottom: var(--space-3);
  }
  
  #dataset-sample .search-input {
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background-color: var(--panel);
    color: var(--text);
    font-size: 0.95rem;
    width: 100%;
    max-width: 400px;
    transition: all 0.2s;
  }
  
  #dataset-sample .search-input:focus {
    outline: none;
    border-color: var(--accent);
    background-color: var(--panel2);
    box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
  }
  
  #dataset-sample .search-input::placeholder {
    color: var(--text-dim);
  }
  
  #dataset-sample .sample-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    min-width: 900px;
  }
  
  #dataset-sample .sample-table thead th {
    position: sticky;
    top: 0;
    background-color: var(--panel2);
    padding: 14px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border2);
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    z-index: 10;
    transition: background-color 0.2s;
  }
  
  #dataset-sample .sample-table thead th:hover {
    background-color: var(--panel3);
  }
  
  #dataset-sample .sample-table thead th.numeric {
    text-align: right;
  }
  
  #dataset-sample .sample-table thead th.expand-col {
    min-width: 150px;
    cursor: default;
  }
  
  #dataset-sample .sample-table tbody tr.sample-row {
    border-bottom: 1px solid var(--border);
    transition: background-color 0.15s;
  }
  
  #dataset-sample .sample-table tbody tr.sample-row:nth-child(4n+1) {
    background-color: rgba(255, 255, 255, 0.02);
  }
  
  #dataset-sample .sample-table tbody tr.sample-row:hover {
    background-color: var(--panel2);
  }
  
  #dataset-sample .sample-table tbody td {
    padding: 12px 16px;
    line-height: 1.5;
  }
  
  #dataset-sample .sample-table tbody td.symbol-cell {
    font-family: 'Courier New', monospace;
    color: var(--accent);
    font-weight: 600;
  }
  
  #dataset-sample .sample-table tbody td.numeric {
    text-align: right;
    font-family: 'Courier New', monospace;
  }
  
  #dataset-sample .expand-btn {
    background-color: var(--panel);
    border: 1px solid var(--border);
    color: var(--text);
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: 6px;
    margin-right: 6px;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  #dataset-sample .expand-btn:hover {
    background-color: var(--panel2);
    border-color: var(--accent);
    color: var(--accent);
    transform: translateY(-1px);
  }
  
  #dataset-sample .expand-btn:last-child {
    margin-right: 0;
  }
  
  #dataset-sample .expand-btn.active {
    background-color: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
  }
  
  #dataset-sample .json-row td {
    padding: 0 !important;
    background-color: var(--bg);
    border-top: 2px solid var(--accent-dim);
  }
  
  #dataset-sample .json-header {
    padding: 12px 16px;
    background-color: var(--panel2);
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  #dataset-sample .json-content {
    margin: 0;
    padding: 20px;
    background-color: #1a1a1a;
    overflow-x: auto;
    font-size: 0.85rem;
    font-family: 'Courier New', Consolas, monospace;
    color: #d4d4d4;
    max-height: 500px;
    overflow-y: auto;
    line-height: 1.5;
  }
  
  #dataset-sample .json-content code {
    font-family: inherit;
  }
  
  #dataset-sample .no-data {
    padding: var(--space-3);
    color: var(--text-muted);
    font-style: italic;
  }
  
  #dataset-sample .loading-message {
    padding: var(--space-4);
    text-align: center;
    color: var(--text-muted);
  }
  
  #dataset-sample .error-message {
    padding: var(--space-4);
    text-align: center;
    color: #ef4444;
  }
</style>


